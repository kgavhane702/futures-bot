<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bot Admin</title>
    <style>
      body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background: #0b1020; color: #e6e8f0; }
      header { padding: 16px; background: #0e1630; position: sticky; top: 0; z-index: 10; border-bottom: 1px solid #1b2545; display:flex; justify-content:space-between; align-items:center }
      a { color: #8fb3ff; text-decoration:none }
      .container { padding: 16px; max-width: 900px; margin: 0 auto; }
      .grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
      .card { background: #111936; border: 1px solid #1b2545; border-radius: 12px; padding: 16px; }
      label { display:block; font-size:12px; color:#a8b3cf; margin-top:10px }
      input, select { width:100%; padding:8px; margin-top:4px; border-radius:8px; border:1px solid #1b2545; background:#0e1330; color:#e6e8f0 }
      button { background:#2b6ef3; color:#fff; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; margin-top:12px }
      .row { display:grid; grid-template-columns: 1fr 1fr; gap:12px }
      .msg { font-size:12px; color:#9bd } 
      pre { white-space:pre-wrap; word-break:break-word; background:#0d142e; padding:12px; border-radius:8px; border:1px solid #1b2545 }
    </style>
  </head>
  <body>
    <header>
      <div><a href="/">Dashboard</a> Â· <strong>Admin</strong></div>
      <div>
        <button onclick="doPull()">Git Pull</button>
      </div>
    </header>
    <div class="container">
      <div class="card">
        <h3>Credentials</h3>
        <div class="msg">Only API key/secret can be updated here.</div>
        <div id="msg" class="msg"></div>
        <form id="envForm" onsubmit="return saveEnv(event)">
          <div class="row">
            <div>
              <label>API_KEY</label>
              <div class="msg">Current: {{ env['API_KEY'] or '(not set)' }}</div>
              <input name="API_KEY" type="password" value="{{ env['API_KEY'] }}" />
            </div>
            <div>
              <label>API_SECRET</label>
              <div class="msg">Current: {{ env['API_SECRET'] or '(not set)' }}</div>
              <input name="API_SECRET" type="password" value="{{ env['API_SECRET'] }}" />
            </div>
          </div>
          <button type="submit">Save .env</button>
        </form>
      </div>
      <div class="card">
        <h3>Universe</h3>
        <div class="msg">Adjust the number of symbols scanned.</div>
        <form id="uniForm" onsubmit="return saveUniverse(event)">
          <label>UNIVERSE_SIZE</label>
          <input name="UNIVERSE_SIZE" placeholder="e.g., 12" value="{{ env['UNIVERSE_SIZE'] or '' }}" />
          <button type="submit">Save</button>
        </form>
      </div>
      <div class="card">
        <h3>Actions</h3>
        <button onclick="doPull()">Git Pull</button>
        <div id="actionOut"></div>
      </div>
    </div>
    <script>
      async function saveEnv(e){
        e.preventDefault();
        const form = document.getElementById('envForm');
        const data = Object.fromEntries(new FormData(form).entries());
        // Strip masked placeholders to avoid overwriting
        if(data.API_KEY && data.API_KEY.startsWith('***')) delete data.API_KEY;
        if(data.API_SECRET && data.API_SECRET.startsWith('***')) delete data.API_SECRET;
        const r = await fetch('/api/env', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data) });
        const j = await r.json();
        document.getElementById('msg').textContent = j.ok ? 'Saved .env' : ('Failed: '+(j.error||''));
        return false;
      }
      async function doPull(){
        const r = await fetch('/api/git_pull', { method:'POST' }); const j = await r.json();
        const el = document.getElementById('actionOut'); el.innerHTML = '<pre>'+JSON.stringify(j, null, 2)+'</pre>';
      }
      
      async function saveUniverse(e){
        e.preventDefault();
        const form = document.getElementById('uniForm');
        const data = Object.fromEntries(new FormData(form).entries());
        const r = await fetch('/api/env', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ UNIVERSE_SIZE: data.UNIVERSE_SIZE }) });
        const j = await r.json();
        document.getElementById('msg').textContent = j.ok ? 'Saved UNIVERSE_SIZE' : ('Failed: '+(j.error||''));
        return false;
      }
    </script>
  </body>
 </html>


